<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8 h-screen">
    
    <div class="flex gap-8 h-full">
        <div class="w-[70%] bg-white p-4 rounded-lg shadow-lg">
            <canvas id="lineChart"></canvas>
        </div>
        
        <div class="w-[30%] bg-white p-4 rounded-lg shadow-lg flex flex-col gap-4">
            <input type="text" id="searchInput" placeholder="Enter product name..." class="border border-gray-300 rounded px-3 py-2">
            <ul id="resultsArea" class="border border-gray-300 rounded px-3 py-2 flex-1 overflow-auto bg-white"></ul>
            <div id="imageArea" class="border border-gray-300 rounded p-2 bg-gray-50 overflow-auto"></div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50" onclick="hideModal()">
        <img id="modalImage" class="max-w-full max-h-full">
    </div>
    
    <script>
        function showModal(imagePath) {
            document.getElementById('modalImage').src = imagePath;
            document.getElementById('imageModal').classList.remove('hidden');
        }
        
        function hideModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }
        // Line Chart
        const chart = new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Price',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Price'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });

        // Strip diacritics function
        const stripDiacritics = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        let mapToString = item => `${stripDiacritics(item.product_name)} | ${item.date} | ${item.size_weight_count} | ${item.price}`;

        let allData = [];
        let currentData = [];

        // Filter and display results
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = stripDiacritics(e.target.value.toLowerCase());
            currentData = allData.filter(item =>
                item.product_name && stripDiacritics(item.product_name.toLowerCase()).includes(searchTerm)
            );
            // console.log(currentData[0])
            const listItems = currentData.map(mapToString).map(text => `<li class="cursor-pointer hover:bg-gray-100 p-1">${text}</li>`)
            document.getElementById('resultsArea').innerHTML = ''
            document.getElementById('resultsArea').innerHTML = listItems.join('');

            // Update chart
            const sortedFiltered = [...currentData].sort((a, b) => new Date(a.date) - new Date(b.date));
            chart.data.labels = sortedFiltered.map(item => item.date);
            chart.data.datasets[0].data = sortedFiltered.map(item => item.price);
            chart.update();
        });

        // Load data from file
        fetch('beirariosm-12b-parsed.out')
            .then(response => response.text())
            .then(text => {
                const lines = text.trim().split('\n');
                allData = lines.map(line => JSON.parse(line));

                // Show all data initially
                document.getElementById('searchInput').dispatchEvent(new Event('input'))
            })
            .catch(error => console.error('Error loading file:', error));

        // Handle list clicks
        document.getElementById('resultsArea').addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const listItems = Array.from(e.target.parentNode.children);
                const lineIndex = listItems.indexOf(e.target);
                if (currentData[lineIndex]) {
                    const item = currentData[lineIndex];
                    console.log(lineIndex, e.target.innerHTML, item);
                    const imagePath = `input/${item.supermarket}/products/dated/few/done/${item.date}_${item.supermarket} - ${item.hash}.jpg`;
                    document.getElementById('imageArea').innerHTML = `<img src="${encodeURI(imagePath)}" class="max-w-full h-auto cursor-pointer" onclick="showModal('${encodeURI(imagePath)}')">`;
                }
            }
        });
    </script>
</body>
</html>